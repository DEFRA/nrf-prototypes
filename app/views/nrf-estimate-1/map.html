{% extends "govuk-prototype-kit/layouts/govuk-branded.njk" %}

{% set pageName="Draw a red line boundary" %}

{% block pageTitle %}
Draw a red line boundary - Get an estimate for Nature Restoration Fund Levy - GOV.UK
{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
    .map-container {
        position: relative;
        margin-bottom: 2rem;
    }

    #map {
        height: 500px;
        width: 100%;
        border: 1px solid #b1b4b6;
    }

    .edp-legend {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        max-width: 200px;
    }

    .edp-legend h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: bold;
    }

    .edp-legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-size: 12px;
    }

    .edp-legend-color {
        width: 15px;
        height: 15px;
        margin-right: 8px;
        border: 1px solid #333;
    }

    /* Minimal Leaflet Draw overrides to work with GOV.UK */
    .leaflet-draw-toolbar {
        border: 2px solid #0b0c0c !important;
        background: white !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
    }

    .leaflet-draw-toolbar a {
        background-color: white !important;
        border: 1px solid #0b0c0c !important;
        color: #0b0c0c !important;
    }

    .leaflet-draw-toolbar a:hover {
        background-color: #f3f2f1 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="govuk-width-container">
    <div class="govuk-main-wrapper">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <a href="/nrf-estimate-1/redline-map" class="govuk-back-link">Back</a>

                <form action="/nrf-estimate-1/map" method="post" novalidate>

                    {% if error %}
                    <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert">
                        <h2 class="govuk-error-summary__title" id="error-summary-title">
                            There is a problem
                        </h2>
                        <div class="govuk-error-summary__body">
                            <ul class="govuk-list govuk-error-summary__list">
                                <li>
                                    <a href="#map">{{ error }}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    <div class="govuk-form-group {% if error %}govuk-form-group--error{% endif %}">
                        <h1 class="govuk-label-wrapper">
                            <label class="govuk-label govuk-label--l" for="map">
                                Draw a red line boundary
                            </label>
                        </h1>

                        <div id="map-hint" class="govuk-hint">
                            <p class="govuk-body">
                                Use the map to draw a red line boundary for where your development might be.
                            </p>
                        </div>

                        {% if error %}
                        <p id="map-error" class="govuk-error-message">
                            <span class="govuk-visually-hidden">Error:</span> {{ error }}
                        </p>
                        {% endif %}

                        <div class="govuk-inset-text">
                            <p class="govuk-body govuk-!-margin-bottom-1">
                                <strong>Instructions:</strong>
                            </p>
                            <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-0">
                                <li>Click the polygon tool in the toolbar (top left of map)</li>
                                <li>Click on the map to create points for your development boundary</li>
                                <li>Double-click to finish drawing</li>
                                <li>You can edit or delete your boundary using the toolbar</li>
                            </ul>
                        </div>

                        <div class="map-container">
                            <div id="map">
                                <div id="map-loading"
                                    style="text-align: center; padding: 2rem; background: #f8f8f8; border: 1px solid #ccc;">
                                    <p class="govuk-body">Loading map...</p>
                                </div>
                            </div>
                            <div class="edp-legend">
                                <h4 class="govuk-heading-s">EDP Areas</h4>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #ff6b6b;"></div>
                                    <span class="govuk-body-s">Thames Valley</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #4ecdc4;"></div>
                                    <span class="govuk-body-s">Greater Manchester</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #45b7d1;"></div>
                                    <span class="govuk-body-s">West Midlands</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #96ceb4;"></div>
                                    <span class="govuk-body-s">South West</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #feca57;"></div>
                                    <span class="govuk-body-s">North East</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #ff9ff3;"></div>
                                    <span class="govuk-body-s">Yorkshire</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #a8e6cf;"></div>
                                    <span class="govuk-body-s">East Midlands</span>
                                </div>
                                <div class="edp-legend-item">
                                    <div class="edp-legend-color" style="background-color: #dda0dd;"></div>
                                    <span class="govuk-body-s">East of England</span>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="boundary-data" name="boundary-data" value="{{ existingBoundaryData }}">
                    </div>

                    <button class="govuk-button" type="submit">
                        Continue
                    </button>

                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
    // Initialize map after page is fully loaded
    (function () {
        'use strict';

        // Wait for everything to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            initMap();
        }

        function initMap() {
            // Additional delay to ensure GOV.UK components are ready
            setTimeout(function () {
                console.log('Map script loading...');
                console.log('Leaflet available:', typeof L !== 'undefined');
                console.log('Map container exists:', document.getElementById('map') !== null);

                try {
                    // Hide loading message
                    const loadingDiv = document.getElementById('map-loading');
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }

                    // Initialize the map centered on England
                    const map = L.map('map').setView([52.5, -1.5], 6);
                    console.log('Map initialized');

                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                    console.log('Tiles added');

                    // EDP Boundary data - 8 areas across England
                    const edpBoundaries = [
                        {
                            name: "Thames Valley EDP",
                            color: "#ff6b6b",
                            coordinates: [
                                [51.3, -0.5],
                                [51.3, -0.3],
                                [51.7, -0.3],
                                [51.7, -0.5],
                                [51.3, -0.5]
                            ]
                        },
                        {
                            name: "Greater Manchester EDP",
                            color: "#4ecdc4",
                            coordinates: [
                                [53.3, -2.5],
                                [53.3, -2.1],
                                [53.7, -2.1],
                                [53.7, -2.5],
                                [53.3, -2.5]
                            ]
                        },
                        {
                            name: "West Midlands EDP",
                            color: "#45b7d1",
                            coordinates: [
                                [52.3, -2.0],
                                [52.3, -1.6],
                                [52.7, -1.6],
                                [52.7, -2.0],
                                [52.3, -2.0]
                            ]
                        },
                        {
                            name: "South West EDP",
                            color: "#96ceb4",
                            coordinates: [
                                [50.5, -3.0],
                                [50.5, -2.5],
                                [51.0, -2.5],
                                [51.0, -3.0],
                                [50.5, -3.0]
                            ]
                        },
                        {
                            name: "North East EDP",
                            color: "#feca57",
                            coordinates: [
                                [54.5, -1.8],
                                [54.5, -1.2],
                                [55.0, -1.2],
                                [55.0, -1.8],
                                [54.5, -1.8]
                            ]
                        },
                        {
                            name: "Yorkshire EDP",
                            color: "#ff9ff3",
                            coordinates: [
                                [53.5, -1.5],
                                [53.5, -0.8],
                                [54.2, -0.8],
                                [54.2, -1.5],
                                [53.5, -1.5]
                            ]
                        },
                        {
                            name: "East Midlands EDP",
                            color: "#a8e6cf",
                            coordinates: [
                                [52.5, -1.5],
                                [52.5, -0.8],
                                [53.2, -0.8],
                                [53.2, -1.5],
                                [52.5, -1.5]
                            ]
                        },
                        {
                            name: "East of England EDP",
                            color: "#dda0dd",
                            coordinates: [
                                [51.8, -0.5],
                                [51.8, 0.5],
                                [52.8, 0.5],
                                [52.8, -0.5],
                                [51.8, -0.5]
                            ]
                        }
                    ];

                    // Add EDP boundaries to the map
                    const edpLayers = [];
                    edpBoundaries.forEach((edp, index) => {
                        console.log('Adding EDP boundary:', edp.name, 'with coordinates:', edp.coordinates);
                        const polygon = L.polygon(edp.coordinates, {
                            color: edp.color,
                            weight: 3,
                            opacity: 1,
                            fillColor: edp.color,
                            fillOpacity: 0.4
                        }).addTo(map);

                        // Add popup with EDP name
                        polygon.bindPopup(`<strong>${edp.name}</strong>`);

                        edpLayers.push({
                            name: edp.name,
                            polygon: polygon,
                            coordinates: edp.coordinates
                        });
                    });
                    console.log('EDP boundaries added:', edpLayers.length);

                    // Test if boundaries are visible by fitting map to show them
                    if (edpLayers.length > 0) {
                        const group = new L.featureGroup(edpLayers.map(edp => edp.polygon));
                        map.fitBounds(group.getBounds().pad(0.1));
                        console.log('Map fitted to show EDP boundaries');
                    }

                    // Initialize the draw control
                    const drawnItems = new L.FeatureGroup();
                    map.addLayer(drawnItems);

                    const drawControl = new L.Control.Draw({
                        position: 'topleft',
                        draw: {
                            polygon: {
                                allowIntersection: false,
                                showArea: true,
                                drawError: {
                                    color: '#e1e100',
                                    message: '<strong>Error:</strong> shape edges cannot cross!'
                                },
                                shapeOptions: {
                                    color: '#d4351c',
                                    weight: 3,
                                    opacity: 0.8,
                                    fillColor: '#d4351c',
                                    fillOpacity: 0.2
                                }
                            },
                            polyline: false,
                            rectangle: false,
                            circle: false,
                            marker: false,
                            circlemarker: false
                        },
                        edit: {
                            featureGroup: drawnItems,
                            remove: true
                        }
                    });
                    map.addControl(drawControl);
                    console.log('Draw control added');

                    // Load existing boundary data if available
                    const existingBoundaryData = document.getElementById('boundary-data').value;
                    console.log('Raw boundary data from input:', existingBoundaryData);

                    if (existingBoundaryData) {
                        try {
                            const boundaryData = JSON.parse(existingBoundaryData);
                            console.log('Parsed boundary data:', boundaryData);
                            console.log('Coordinates:', boundaryData.coordinates);
                            console.log('Coordinates type:', typeof boundaryData.coordinates);
                            console.log('Is array:', Array.isArray(boundaryData.coordinates));

                            // Check if coordinates exist and convert to Leaflet format
                            if (boundaryData.coordinates && Array.isArray(boundaryData.coordinates) && boundaryData.coordinates.length > 0) {
                                console.log('Processing coordinates...');
                                const latLngs = boundaryData.coordinates.map(point => [point[1], point[0]]); // Convert [lng, lat] to [lat, lng]
                                console.log('Converted latLngs:', latLngs);

                                // Create and add the existing polygon
                                const existingPolygon = L.polygon(latLngs, {
                                    color: '#d4351c',
                                    weight: 3,
                                    opacity: 0.8,
                                    fillColor: '#d4351c',
                                    fillOpacity: 0.2
                                });

                                drawnItems.addLayer(existingPolygon);

                                // Fit map to show the existing boundary
                                map.fitBounds(existingPolygon.getBounds().pad(0.1));

                                console.log('Existing boundary loaded and displayed successfully');
                            } else {
                                console.log('No valid coordinates found in boundary data. Coordinates:', boundaryData.coordinates);
                            }
                        } catch (error) {
                            console.error('Error loading existing boundary:', error);
                            console.error('Raw data that failed to parse:', existingBoundaryData);
                        }
                    } else {
                        console.log('No existing boundary data found');
                    }

                    // Handle drawing events
                    map.on(L.Draw.Event.CREATED, function (event) {
                        console.log('Polygon created');
                        const layer = event.layer;
                        drawnItems.addLayer(layer);

                        // Check if the drawn polygon intersects with any EDP boundary
                        const drawnBounds = layer.getBounds();
                        const drawnCenter = drawnBounds.getCenter();

                        let intersectingEDP = null;
                        edpLayers.forEach(edp => {
                            if (isPointInPolygon([drawnCenter.lng, drawnCenter.lat], edp.coordinates)) {
                                intersectingEDP = edp;
                            }
                        });

                        // Update the boundary data
                        updateBoundaryData(layer, intersectingEDP);
                    });

                    map.on(L.Draw.Event.EDITED, function (event) {
                        console.log('Polygon edited');
                        const layers = event.layers;
                        layers.eachLayer(function (layer) {
                            const drawnBounds = layer.getBounds();
                            const drawnCenter = drawnBounds.getCenter();

                            let intersectingEDP = null;
                            edpLayers.forEach(edp => {
                                if (isPointInPolygon([drawnCenter.lng, drawnCenter.lat], edp.coordinates)) {
                                    intersectingEDP = edp;
                                }
                            });

                            updateBoundaryData(layer, intersectingEDP);
                        });
                    });

                    map.on(L.Draw.Event.DELETED, function (event) {
                        console.log('Polygon deleted');
                        document.getElementById('boundary-data').value = '';
                    });

                    // Helper function to check if a point is within a polygon
                    function isPointInPolygon(point, polygon) {
                        const x = point[0], y = point[1]; // point is [lng, lat]
                        let inside = false;
                        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                            // polygon coordinates are [lat, lng], so we need to swap them for the algorithm
                            const xi = polygon[i][1], yi = polygon[i][0]; // [lng, lat]
                            const xj = polygon[j][1], yj = polygon[j][0]; // [lng, lat]
                            if (((yi > y) !== (yj > y)) &&
                                (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                                inside = !inside;
                            }
                        }
                        return inside;
                    }

                    // Update boundary data in the hidden input
                    function updateBoundaryData(layer, intersectingEDP) {
                        const bounds = layer.getBounds();
                        const center = bounds.getCenter();
                        const latLngs = layer.getLatLngs()[0];
                        const points = latLngs.map(latLng => [latLng.lng, latLng.lat]);

                        const boundaryData = {
                            center: [center.lng, center.lat],
                            points: points,
                            intersectingEDP: intersectingEDP ? intersectingEDP.name : null
                        };

                        document.getElementById('boundary-data').value = JSON.stringify(boundaryData);
                        console.log('Boundary data updated:', boundaryData);
                    }

                    // Form submission validation
                    document.querySelector('form').addEventListener('submit', function (e) {
                        const boundaryData = document.getElementById('boundary-data').value;
                        if (!boundaryData) {
                            e.preventDefault();
                            alert('Please draw a boundary on the map before continuing.');
                            return false;
                        }
                    });

                    console.log('Map setup complete');
                } catch (error) {
                    console.error('Error initializing map:', error);
                    const loadingDiv = document.getElementById('map-loading');
                    if (loadingDiv) {
                        loadingDiv.innerHTML = '<p class="govuk-body" style="color: red;">Error loading map. Please refresh the page.</p>';
                    }
                }
            }, 1000); // Increased delay to ensure GOV.UK components are ready
        }
    })();
</script>
{% endblock %}