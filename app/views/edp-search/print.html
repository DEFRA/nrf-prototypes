{% extends "layouts/main.html" %}

{% set pageName="Development Site Assessment - Print" %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        <div class="print-header">
            <h1 class="govuk-heading-xl">
                Development Site Assessment Report
            </h1>
            <p class="govuk-body">
                <strong>Assessment Date:</strong> <span id="assessment-date"></span><br>
                <strong>Reference:</strong> <span id="assessment-reference"></span>
            </p>
        </div>

        <div class="print-section">
            <h2 class="govuk-heading-l">Development Site Information</h2>
            <div id="development-info-print"></div>
        </div>

        <div class="print-section">
            <h2 class="govuk-heading-l">Environmental Development Plan Assessment</h2>
            <div id="edp-assessment-print"></div>
        </div>

        <div class="print-section">
            <h2 class="govuk-heading-l">Cost Breakdown</h2>
            <div id="cost-breakdown-print"></div>
        </div>

        <div class="print-section">
            <h2 class="govuk-heading-l">Important Information</h2>
            <div class="govuk-inset-text">
                <p class="govuk-body">
                    <strong>This assessment is valid for 12 months from the date shown above.</strong>
                </p>
                <p class="govuk-body">
                    The costs shown in this assessment are estimates based on the information provided.
                    Final costs may vary depending on the specific requirements of your local planning authority.
                </p>
                <p class="govuk-body">
                    This assessment should be included with your planning application to demonstrate
                    that you have considered environmental impact costs.
                </p>
            </div>
        </div>

        <div class="print-section">
            <h2 class="govuk-heading-l">Next Steps</h2>
            <ol class="govuk-list govuk-list--number">
                <li>Include this assessment with your planning application</li>
                <li>Contact your local planning authority for specific requirements</li>
                <li>Ensure all environmental impact costs are budgeted for</li>
                <li>Keep this assessment for your records</li>
            </ol>
        </div>

        <div class="print-footer">
            <p class="govuk-body">
                <strong>Nature Restoration Fund</strong><br>
                Department for Environment, Food and Rural Affairs<br>
                Assessment generated by the Development Site Assessment Service
            </p>
        </div>

        <div class="no-print">
            <div class="govuk-button-group">
                <button class="govuk-button" data-module="govuk-button" onclick="window.print()">
                    Print assessment
                </button>
                <a href="/edp-search/summary" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                    Back to summary
                </a>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadPrintData();
    });

    function loadPrintData() {
        // Set assessment date and reference
        const now = new Date();
        document.getElementById('assessment-date').textContent = now.toLocaleDateString('en-GB');
        document.getElementById('assessment-reference').textContent = 'EDP-' + now.getFullYear() + '-' + String(now.getTime()).slice(-6);

        // Get data from session storage
        const boundaryData = sessionStorage.getItem('developmentBoundary');
        const locationData = sessionStorage.getItem('developmentLocation');
        const applicableEDPs = sessionStorage.getItem('applicableEDPs');
        const formData = getFormData();

        if (!boundaryData || !locationData) {
            showError('Assessment data not found. Please start a new assessment.');
            return;
        }

        const boundary = JSON.parse(boundaryData);
        const location = JSON.parse(locationData);
        const edps = applicableEDPs ? JSON.parse(applicableEDPs) : [];

        // Display development information
        displayDevelopmentInfoPrint(boundary, location);

        // Display EDP assessment
        displayEDPAssessmentPrint(edps, formData);

        // Display cost breakdown
        displayCostBreakdownPrint(edps, formData);
    }

    function getFormData() {
        // In a real implementation, this would come from form submission
        return {
            houseCount: 50,
            wastewaterSite: 'wwt-001'
        };
    }

    function displayDevelopmentInfoPrint(boundary, location) {
        const developmentInfoPrint = document.getElementById('development-info-print');
        const areaHectares = boundary.area / 10000;

        developmentInfoPrint.innerHTML = `
    <table class="govuk-table">
      <tbody class="govuk-table__body">
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Location</th>
          <td class="govuk-table__cell">${location.address || `${location.coordinates.lat.toFixed(6)}, ${location.coordinates.lng.toFixed(6)}`}</td>
        </tr>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Site Area</th>
          <td class="govuk-table__cell">${areaHectares.toFixed(2)} hectares</td>
        </tr>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Boundary Points</th>
          <td class="govuk-table__cell">${boundary.points.length} points</td>
        </tr>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Assessment Method</th>
          <td class="govuk-table__cell">${location.type === 'postcode' ? 'Postcode lookup' : location.type === 'coordinates' ? 'Coordinate input' : 'Map drawing'}</td>
        </tr>
      </tbody>
    </table>
  `;
    }

    function displayEDPAssessmentPrint(edps, formData) {
        const edpAssessmentPrint = document.getElementById('edp-assessment-print');

        if (edps.length === 0) {
            edpAssessmentPrint.innerHTML = `
      <div class="govuk-inset-text">
        <p class="govuk-body">
          <strong>Result:</strong> No applicable Environmental Development Plans found
        </p>
        <p class="govuk-body">
          Your development site does not fall within any Environmental Development Plan boundaries 
          that require payment for environmental impact mitigation.
        </p>
      </div>
    `;
            return;
        }

        let edpTable = `
    <p class="govuk-body">The following Environmental Development Plans apply to your development site:</p>
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">EDP Name</th>
          <th scope="col" class="govuk-table__header">Type</th>
          <th scope="col" class="govuk-table__header">Details</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">
  `;

        edps.forEach(edp => {
            let details = '';
            if (edp.type === 'DLL' && formData.houseCount) {
                details = `${formData.houseCount} houses`;
            } else if (edp.type === 'Nutrient Mitigation' && formData.wastewaterSite) {
                details = 'Wastewater treatment site selected';
            }

            edpTable += `
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">${edp.name}</td>
        <td class="govuk-table__cell">${edp.type}</td>
        <td class="govuk-table__cell">${details}</td>
      </tr>
    `;
        });

        edpTable += `
      </tbody>
    </table>
  `;

        edpAssessmentPrint.innerHTML = edpTable;
    }

    function displayCostBreakdownPrint(edps, formData) {
        const costBreakdownPrint = document.getElementById('cost-breakdown-print');

        if (edps.length === 0) {
            costBreakdownPrint.innerHTML = `
      <div class="govuk-inset-text">
        <p class="govuk-body">
          <strong>Total Environmental Impact Cost:</strong> £0
        </p>
        <p class="govuk-body">
          No environmental impact costs are required for this development.
        </p>
      </div>
    `;
            return;
        }

        let totalCost = 0;
        let costTable = `
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">EDP</th>
          <th scope="col" class="govuk-table__header">Calculation</th>
          <th scope="col" class="govuk-table__header govuk-table__header--numeric">Cost</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">
  `;

        edps.forEach(edp => {
            let cost = 0;
            let description = '';

            if (edp.type === 'DLL' && formData.houseCount) {
                cost = formData.houseCount * edp.rate;
                description = `${formData.houseCount} houses × £${edp.rate.toLocaleString()}`;
            } else if (edp.type === 'Nutrient Mitigation' && formData.wastewaterSite) {
                cost = formData.houseCount * edp.rate;
                description = `${formData.houseCount} houses × £${edp.rate.toLocaleString()}`;
            }

            totalCost += cost;

            costTable += `
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">${edp.name}</td>
        <td class="govuk-table__cell">${description}</td>
        <td class="govuk-table__cell govuk-table__cell--numeric">£${cost.toLocaleString()}</td>
      </tr>
    `;
        });

        costTable += `
        <tr class="govuk-table__row govuk-table__row--total">
          <th scope="row" class="govuk-table__header">Total Environmental Impact Cost</th>
          <td class="govuk-table__cell"></td>
          <td class="govuk-table__cell govuk-table__cell--numeric"><strong>£${totalCost.toLocaleString()}</strong></td>
        </tr>
      </tbody>
    </table>
  `;

        costBreakdownPrint.innerHTML = costTable;
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'govuk-error-summary';
        errorDiv.setAttribute('aria-labelledby', 'error-summary-title');
        errorDiv.setAttribute('role', 'alert');
        errorDiv.setAttribute('tabindex', '-1');
        errorDiv.innerHTML = `
    <h2 class="govuk-error-summary__title" id="error-summary-title">
      There is a problem
    </h2>
    <div class="govuk-error-summary__body">
      <ul class="govuk-list govuk-error-summary__list">
        <li><a href="#">${message}</a></li>
      </ul>
    </div>
  `;

        const content = document.querySelector('.govuk-grid-column-full');
        content.insertBefore(errorDiv, content.firstChild);
    }
</script>

<style>
    @media print {
        .no-print {
            display: none !important;
        }

        .print-header {
            border-bottom: 2px solid #0b0c0c;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .print-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }

        .print-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #0b0c0c;
            font-size: 14px;
        }

        .govuk-table__row--total {
            border-top: 2px solid #0b0c0c;
            font-weight: bold;
        }
    }

    .govuk-table__row--total {
        border-top: 2px solid #0b0c0c;
        font-weight: bold;
    }
</style>

{% endblock %}