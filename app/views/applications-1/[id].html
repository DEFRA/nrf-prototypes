{% extends "layouts/main.html" %}

{% set pageName="Application Details" %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

        <h1 class="govuk-heading-l">
            Application {{ application.id }}
        </h1>

        <!-- Status Banner -->
        <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title"
            data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                    Application status
                </h2>
            </div>
            <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                    {% if application.status == 'pending_payment' %}
                    <strong class="govuk-tag govuk-tag--orange">Pending Payment</strong> - Payment required to proceed
                    {% elif application.status == 'paid' %}
                    <strong class="govuk-tag govuk-tag--green">Paid</strong> - Application under review
                    {% elif application.status == 'approved' %}
                    <strong class="govuk-tag govuk-tag--blue">Approved</strong> - Environmental permit issued
                    {% elif application.status == 'draft' %}
                    <strong class="govuk-tag govuk-tag--grey">Draft</strong> - Application in progress
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Development Information -->
        <h2 class="govuk-heading-l">Development information</h2>

        <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Development name</dt>
                <dd class="govuk-summary-list__value">{{ application.developmentName }}</dd>
            </div>
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Number of houses</dt>
                <dd class="govuk-summary-list__value">{{ application.houseCount }}</dd>
            </div>
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Date submitted</dt>
                <dd class="govuk-summary-list__value">{{ application.createdAt | formatDate }}</dd>
            </div>
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Last updated</dt>
                <dd class="govuk-summary-list__value">{{ application.updatedAt | formatDate }}</dd>
            </div>
        </dl>

        <!-- Location Information -->
        <h2 class="govuk-heading-l">Location</h2>

        <div class="govuk-summary-list">
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Development site</dt>
                <dd class="govuk-summary-list__value">
                    {% if application.location.center %}
                    {{ application.location.center[1] | round(4) }}, {{ application.location.center[0] | round(4) }}
                    {% else %}
                    Boundary provided
                    {% endif %}
                </dd>
            </div>
        </div>

        <!-- Development Boundary Map -->
        <h3 class="govuk-heading-m">Development boundary map</h3>

        <div id="map-container" style="height: 400px; width: 100%; border: 2px solid #0b0c0c; margin-bottom: 20px;">
            <div id="map" style="height: 100%; width: 100%;"></div>
        </div>

        <div id="application-data" style="display: none;"></div>

        <script type="application/json" id="application-location-data">
            {{ application.location | safe }}
        </script>
        <script type="application/json" id="application-edps-data">
            {{ application.applicableEDPs | safe }}
        </script>

        <div class="govuk-hint">
            The map shows your development boundary and applicable Environmental Development Plan areas.
        </div>

        <!-- Environmental Development Plans -->
        <h2 class="govuk-heading-l">Environmental Development Plans</h2>

        {% if application.applicableEDPs and application.applicableEDPs.length > 0 %}

        <div class="govuk-table__container">
            <table class="govuk-table">
                <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header">EDP Type</th>
                        <th scope="col" class="govuk-table__header">Name</th>
                        <th scope="col" class="govuk-table__header">Rate per house</th>
                        <th scope="col" class="govuk-table__header">Total amount</th>
                    </tr>
                </thead>
                <tbody class="govuk-table__body">
                    {% for edp in application.applicableEDPs %}
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">
                            <strong>{{ edp.type }}</strong>
                        </td>
                        <td class="govuk-table__cell">
                            {{ edp.name }}
                        </td>
                        <td class="govuk-table__cell">
                            {{ edp.rate | formatCurrency }}
                        </td>
                        <td class="govuk-table__cell">
                            <strong>{{ edp.impact | formatCurrency }}</strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}

        <div class="govuk-inset-text">
            <p class="govuk-body">
                No Environmental Development Plans apply to this development site.
            </p>
        </div>

        {% endif %}

        <!-- Quote Information -->
        {% if application.quote %}
        <h2 class="govuk-heading-l">Levy quote</h2>

        <div class="govuk-panel govuk-panel--confirmation">
            <h1 class="govuk-panel__title">
                Total levy: {{ application.quote.total | formatCurrency }}
            </h1>
        </div>

        <h3 class="govuk-heading-m">Breakdown</h3>

        <div class="govuk-table__container">
            <table class="govuk-table">
                <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header">Description</th>
                        <th scope="col" class="govuk-table__header">Rate</th>
                        <th scope="col" class="govuk-table__header">Houses</th>
                        <th scope="col" class="govuk-table__header">Amount</th>
                    </tr>
                </thead>
                <tbody class="govuk-table__body">
                    {% for item in application.quote.breakdown %}
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">
                            {{ item.description }}
                        </td>
                        <td class="govuk-table__cell">
                            {{ item.rate | formatCurrency }}
                        </td>
                        <td class="govuk-table__cell">
                            {{ item.houseCount }}
                        </td>
                        <td class="govuk-table__cell">
                            <strong>{{ item.amount | formatCurrency }}</strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Payment Information -->
        {% if application.paymentStatus %}
        <h2 class="govuk-heading-l">Payment information</h2>

        <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Payment status</dt>
                <dd class="govuk-summary-list__value">
                    {% if application.paymentStatus == 'completed' %}
                    <strong class="govuk-tag govuk-tag--green">Completed</strong>
                    {% elif application.paymentStatus == 'pending' %}
                    <strong class="govuk-tag govuk-tag--orange">Pending</strong>
                    {% else %}
                    <strong class="govuk-tag govuk-tag--grey">{{ application.paymentStatus }}</strong>
                    {% endif %}
                </dd>
            </div>
            {% if application.paymentReference %}
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Payment reference</dt>
                <dd class="govuk-summary-list__value">{{ application.paymentReference }}</dd>
            </div>
            {% endif %}
        </dl>
        {% endif %}

        <!-- Actions -->
        <div class="govuk-button-group">
            {% if application.status == 'pending_payment' %}
            <a href="/applications-1/{{ application.id }}/payment" class="govuk-button" data-module="govuk-button">
                Make payment
            </a>
            {% endif %}
            <a href="/applications-1" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                Back to applications
            </a>
        </div>

    </div>

    <div class="govuk-grid-column-one-third">
        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Application timeline</h2>
                <ul class="govuk-list govuk-list--bullet">
                    <li><strong>{{ application.createdAt | formatDate }}</strong> - Application submitted</li>
                    {% if application.status != 'draft' %}
                    <li><strong>{{ application.updatedAt | formatDate }}</strong> - Quote generated</li>
                    {% endif %}
                    {% if application.paymentStatus == 'completed' %}
                    <li><strong>Payment completed</strong> - Under review</li>
                    {% endif %}
                    {% if application.status == 'approved' %}
                    <li><strong>Approved</strong> - Environmental permit issued</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        {% if application.wastewaterTreatmentSite %}
        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Wastewater treatment</h2>
                <p class="govuk-body-s">
                    <strong>Site:</strong> {{ application.wastewaterTreatmentSite }}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the map
        const map = L.map('map').setView([54.0, -2.0], 6);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Application data from the server
        const applicationData = {
            location: JSON.parse(document.getElementById('application-location-data').textContent),
            applicableEDPs: JSON.parse(document.getElementById('application-edps-data').textContent)
        };

        console.log('Application data:', applicationData);

        // Add development boundary if available
        if (applicationData.location && applicationData.location.boundary) {
            const developmentBoundary = L.geoJSON(applicationData.location.boundary, {
                style: {
                    color: '#d4351c',
                    weight: 3,
                    fillColor: '#d4351c',
                    fillOpacity: 0.3
                }
            }).addTo(map);

            // Add popup for development boundary
            developmentBoundary.bindPopup('<strong>Development Boundary</strong><br>Your proposed development site');

            // Fit map to development boundary
            map.fitBounds(developmentBoundary.getBounds());
        } else if (applicationData.location && applicationData.location.center) {
            // If no boundary, center on the development location
            const [lng, lat] = applicationData.location.center;
            map.setView([lat, lng], 12);

            // Add a marker for the development site
            L.marker([lat, lng])
                .addTo(map)
                .bindPopup('Development site location');
        }

        // Add applicable EDP boundaries to map
        if (applicationData.applicableEDPs && applicationData.applicableEDPs.length > 0) {
            applicationData.applicableEDPs.forEach(edp => {
                console.log('Processing EDP:', edp);

                if (edp.boundary) {
                    const color = edp.type === 'DLL' ? '#00703c' : '#1d70b8';
                    const layer = L.geoJSON(edp.boundary, {
                        style: {
                            color: color,
                            weight: 2,
                            fillColor: color,
                            fillOpacity: 0.1
                        }
                    }).addTo(map);

                    // Add popup for EDP boundary
                    layer.bindPopup(`<strong>${edp.name}</strong><br>${edp.type} area<br>Rate: £${edp.rate} per house`);

                    console.log('Added EDP boundary to map:', edp.name);
                } else {
                    console.log('No boundary data for EDP:', edp.name);
                }
            });
        } else {
            console.log('No applicable EDPs found');
        }

        // Add legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.backgroundColor = 'white';
            div.style.padding = '10px';
            div.style.border = '2px solid #ccc';
            div.style.borderRadius = '5px';
            div.style.fontSize = '12px';

            div.innerHTML = '<h4 style="margin: 0 0 10px 0;">Map Legend</h4>' +
                '<div style="margin-bottom: 5px;"><span style="display: inline-block; width: 20px; height: 3px; background-color: #d4351c; margin-right: 5px;"></span> Development Boundary</div>' +
                '<div style="margin-bottom: 5px;"><span style="display: inline-block; width: 20px; height: 2px; background-color: #00703c; margin-right: 5px;"></span> DLL Area</div>' +
                '<div style="margin-bottom: 5px;"><span style="display: inline-block; width: 20px; height: 2px; background-color: #1d70b8; margin-right: 5px;"></span> Nutrient Mitigation Area</div>';

            return div;
        };
        legend.addTo(map);
    });
</script>

{% endblock %}