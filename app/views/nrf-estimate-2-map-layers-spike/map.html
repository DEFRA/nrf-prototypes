{% extends "layouts/map.html" %}

{% set pageName="Draw a red line boundary" %}

{% block pageTitle %}
Draw a red line boundary - {% if data.journeyType === 'payment' %}Pay for Nature Restoration Fund Levy{% else %}Get an
estimate for Nature Restoration Fund Levy{% endif %} - GOV.UK
{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
    body, html {
        overflow: hidden !important;
    }

    .map-controls-panel .govuk-back-link {
        margin-bottom: 20px;
    }

    /* Map style switcher button */
    .map-style-button {
        background: white;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        padding: 0;
        margin-bottom: 10px !important;
    }

    .map-style-button:hover {
        background: #f3f2f1;
    }

    .map-style-button:focus {
        outline: 3px solid #ffdd00;
        outline-offset: 0;
    }

    .map-style-button svg {
        width: 22px;
        height: 22px;
    }

    /* Map style selector specific styles */
    .map-style-options {
        display: flex;
        gap: 20px;
    }

    .map-style-option {
        background: white;
        border: none;
        border-radius: 0;
        padding: 0;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
    }

    .map-style-option:hover .map-style-thumbnail {
        border: 3px solid #b1b4b6;
    }

    .map-style-option:focus {
        outline: 3px solid #ffdd00;
        outline-offset: 3px;
    }

    .map-style-option--selected .map-style-thumbnail {
        border: 3px solid #0b0c0c;
    }

    .map-style-thumbnail {
        width: 60px;
        height: 60px;
        border: 3px solid #ffffff;
        border-radius: 0;
        overflow: hidden;
        transition: all 0.2s;
        padding: 3px;
        background: white;
    }

    .map-style-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .map-style-label {
        font-size: 18px;
        font-weight: 400;
        color: #0b0c0c;
        text-align: center;
        font-family: "GDS Transport", arial, sans-serif;
    }
</style>
{% endblock %}


{% block content %}


<form id="map-form" action="/nrf-estimate-2-map-layers-spike/map" method="post" novalidate style="height: 100%;">
            {% if navFromSummary %}
            <input type="hidden" name="navFromSummary" value="true">
            {% endif %}

            {% if error %}
            <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert">
                <h2 class="govuk-error-summary__title" id="error-summary-title">
                    There is a problem
                </h2>
                <div class="govuk-error-summary__body">
                    <ul class="govuk-list govuk-error-summary__list">
                        <li>
                            <a href="#map">{{ error }}</a>
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}

            <div class="govuk-form-group {% if error %}govuk-form-group--error{% endif %}">
                {% if error %}
                <p id="map-error" class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span> {{ error }}
                </p>
                {% endif %}

            <div id="client-error-summary" class="govuk-error-summary govuk-!-margin-top-6" aria-labelledby="error-summary-title" role="alert" style="display: none;">
                <h2 class="govuk-error-summary__title" id="error-summary-title">
                    There is a problem
                </h2>
                <div class="govuk-error-summary__body">
                    <ul class="govuk-list govuk-error-summary__list">
                        <li>
                            <a href="#map" id="client-error-link"></a>
                        </li>
                    </ul>
                </div>
            </div>

                <!-- Main map content container -->
                <div id="map-content" style="height: calc(100vh - 60px);">

                <!-- Accessible map interface with left panel -->
                <div class="map-interface" style="height: 100%;">
                    <!-- Left control panel -->
                    <div class="map-controls-panel">
                        <a href="{{ backLink }}" class="govuk-back-link">Back</a>

                        <h1 class="govuk-heading-m">
                            Draw a red line boundary
                        </h1>

                        <p class="govuk-body-s govuk-!-margin-bottom-6">
                            Use the map to draw a red line boundary for where the development might be.
                        </p>

                        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

                        <!-- Drawing tools -->
                        <div class="govuk-form-group">
                            <h2 class="govuk-heading-s">Drawing tools</h2>
                            <div class="tool-links">
                                <button type="button" class="govuk-link" id="start-drawing" data-tool="polygon"
                                    aria-describedby="drawing-instructions">
                                    Start drawing boundary
                                </button>
                                <button type="button" class="govuk-link" id="edit-boundary" data-tool="edit"
                                    aria-describedby="edit-instructions" disabled style="display: none;">
                                    Edit boundary
                                </button>
                                <button type="button" class="govuk-link govuk-link--destructive" id="delete-boundary"
                                    data-tool="delete" aria-describedby="delete-instructions" disabled>
                                    Delete boundary
                                </button>
                            </div>
                        </div>

                        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

                        <!-- Map controls -->
                        <div class="govuk-form-group">
                            <h2 class="govuk-heading-s">Map view</h2>
                            <div class="tool-links">
                                <button type="button" class="govuk-link" id="zoom-to-england" aria-describedby="zoom-england-help">
                                    Show all England
                                </button>
                                <button type="button" class="govuk-link" id="zoom-to-boundary"
                                    aria-describedby="zoom-boundary-help" disabled>
                                    Zoom to boundary
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Map container -->
                    <div class="map-container" style="height: 100%;">
                        <div id="map" role="img" aria-label="Interactive map for drawing development boundary" style="height: 100%;">
                            <div id="map-loading"
                                style="text-align: center; padding: 2rem; background: #f8f8f8; border: 1px solid #ccc;">
                                <p class="govuk-body">Loading map...</p>
                            </div>
                        </div>

                        <!-- Floating save button - only shown when boundary exists -->
                        <div id="map-save-button-container" style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
                            <div style="background: #ffffff; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); border-radius: 4px;">
                                <button class="govuk-button govuk-!-margin-bottom-0" type="submit" data-module="govuk-button">
                                    Save and continue
                                </button>
                            </div>
                        </div>

                        <!-- Edit mode buttons - only shown when in edit mode -->
                        <div id="map-edit-buttons-container" style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
                            <div style="background: #ffffff; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); border-radius: 4px; display: flex; gap: 10px;">
                                <button class="govuk-button govuk-!-margin-bottom-0" type="button" id="confirm-edit-btn" data-module="govuk-button">
                                    Confirm area
                                </button>
                                <button class="govuk-button govuk-button--secondary govuk-!-margin-bottom-0" type="button" id="cancel-edit-btn" data-module="govuk-button">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="boundary-data" name="boundary-data" value="{{ existingBoundaryData }}">
            </div>
        </form>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="/public/javascripts/utils.js"></script>
<script src="/public/javascripts/components/modal.js"></script>
<script src="/public/javascripts/map-drawing-layers-spike.js"></script>
{% endblock %}
