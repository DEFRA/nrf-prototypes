{% extends "layouts/main.html" %}

{% set pageName="New Application - Coordinates" %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

        <h1 class="govuk-heading-xl">
            Enter your development site coordinates
        </h1>

        <p class="govuk-body">
            Enter the latitude and longitude coordinates of your development site. We'll show you the location on a map
            where you can draw your development boundary.
        </p>

        <form action="/applications/new/location-draw" method="post">
            <div class="govuk-form-group">
                <label class="govuk-label" for="latitude">
                    Latitude
                </label>
                <div id="latitude-hint" class="govuk-hint">
                    Enter a value between -90 and 90 (e.g., 51.5074)
                </div>
                <input class="govuk-input govuk-input--width-10" id="latitude" name="latitude" type="number" step="any"
                    aria-describedby="latitude-hint" placeholder="51.5074">
            </div>

            <div class="govuk-form-group">
                <label class="govuk-label" for="longitude">
                    Longitude
                </label>
                <div id="longitude-hint" class="govuk-hint">
                    Enter a value between -180 and 180 (e.g., -0.1278)
                </div>
                <input class="govuk-input govuk-input--width-10" id="longitude" name="longitude" type="number"
                    step="any" aria-describedby="longitude-hint" placeholder="-0.1278">
            </div>

            <div id="coordinates-error" class="govuk-error-summary" style="display: none;"
                aria-labelledby="error-summary-title" role="alert" tabindex="-1">
                <h2 class="govuk-error-summary__title" id="error-summary-title">
                    There is a problem
                </h2>
                <div class="govuk-error-summary__body">
                    <ul class="govuk-list govuk-error-summary__list" id="error-list">
                    </ul>
                </div>
            </div>

            <div id="coordinates-result" class="govuk-inset-text" style="display: none;">
                <h3 class="govuk-heading-s">Location found</h3>
                <div id="result-content"></div>
            </div>

            <div class="govuk-button-group">
                <button class="govuk-button" data-module="govuk-button" type="button" onclick="validateCoordinates()">
                    Validate coordinates
                </button>
                <button class="govuk-button" data-module="govuk-button" type="submit" id="continue-button" disabled>
                    Continue to map
                </button>
                <a href="/applications/new/location" class="govuk-button govuk-button--secondary"
                    data-module="govuk-button">
                    Back
                </a>
            </div>
        </form>

    </div>

    <div class="govuk-grid-column-one-third">
        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Coordinate format</h2>
                <p class="govuk-body">Enter coordinates in decimal degrees:</p>
                <ul class="govuk-list govuk-list--bullet">
                    <li><strong>Latitude:</strong> -90 to 90</li>
                    <li><strong>Longitude:</strong> -180 to 180</li>
                    <li>Use decimal places for precision</li>
                    <li>Example: 51.5074, -0.1278</li>
                </ul>
            </div>
        </div>

        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Application progress</h2>
                <ol class="govuk-list govuk-list--number">
                    <li><strong>Location</strong> ‚Üê You are here</li>
                    <li>EDP check</li>
                    <li>Additional details</li>
                    <li>Review quote</li>
                    <li>Payment</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const continueButton = document.getElementById('continue-button');

        // Add input event listeners for real-time validation
        latitudeInput.addEventListener('input', function () {
            validateCoordinates();
        });

        longitudeInput.addEventListener('input', function () {
            validateCoordinates();
        });

        // Add form submission handler
        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();
            if (validateCoordinates()) {
                // Store coordinates in session storage for map drawing
                sessionStorage.setItem('developmentCoordinates', JSON.stringify({
                    lat: parseFloat(latitudeInput.value),
                    lng: parseFloat(longitudeInput.value)
                }));
                window.location.href = '/applications/new/location-draw';
            }
        });
    });

    function validateCoordinates() {
        const latitude = parseFloat(document.getElementById('latitude').value);
        const longitude = parseFloat(document.getElementById('longitude').value);
        const errors = [];

        // Check if values are provided
        if (isNaN(latitude)) {
            errors.push('Please enter a valid latitude');
        } else if (latitude < -90 || latitude > 90) {
            errors.push('Latitude must be between -90 and 90');
        }

        if (isNaN(longitude)) {
            errors.push('Please enter a valid longitude');
        } else if (longitude < -180 || longitude > 180) {
            errors.push('Longitude must be between -180 and 180');
        }

        if (errors.length > 0) {
            showError(errors);
            return false;
        }

        // Check if coordinates are within the UK (rough bounds)
        if (latitude < 49.9 || latitude > 60.9 || longitude < -8.2 || longitude > 1.8) {
            showError(['Coordinates appear to be outside the UK. Please check and try again.']);
            return false;
        }

        hideError();
        showResult(latitude, longitude);
        return true;
    }

    function showResult(latitude, longitude) {
        // Mock location lookup - in a real implementation, this would call a geocoding API
        const mockAddresses = {
            '51.5074,-0.1278': 'London, England',
            '53.4808,-2.2426': 'Manchester, England',
            '52.4862,-1.8904': 'Birmingham, England',
            '51.3760,-0.0982': 'Croydon, England'
        };

        const key = `${latitude.toFixed(4)},${longitude.toFixed(4)}`;
        const address = mockAddresses[key] || 'Location in the UK';

        document.getElementById('result-content').innerHTML = `
            <p class="govuk-body"><strong>Coordinates:</strong> ${latitude.toFixed(6)}, ${longitude.toFixed(6)}</p>
            <p class="govuk-body"><strong>Location:</strong> ${address}</p>
        `;
        document.getElementById('coordinates-result').style.display = 'block';
        document.getElementById('continue-button').disabled = false;
    }

    function showError(errors) {
        const errorList = document.getElementById('error-list');
        errorList.innerHTML = '';
        errors.forEach(error => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#latitude';
            a.textContent = error;
            li.appendChild(a);
            errorList.appendChild(li);
        });
        document.getElementById('coordinates-error').style.display = 'block';
        document.getElementById('coordinates-result').style.display = 'none';
        document.getElementById('continue-button').disabled = true;
    }

    function hideError() {
        document.getElementById('coordinates-error').style.display = 'none';
    }
</script>

{% endblock %}