{% extends "layouts/main.html" %}

{% set pageName="New Application - Draw Boundary" %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

        <h1 class="govuk-heading-xl">
            Draw your development boundary
        </h1>

        <p class="govuk-body">
            Use the map below to draw the boundary of your development site. Click on the map to add points to your
            boundary.
        </p>

        <div id="map-container" style="height: 400px; border: 2px solid #0b0c0c; margin: 20px 0;">
            <div id="map" style="height: 100%; width: 100%;"></div>
        </div>

        <div class="govuk-inset-text">
            <h3 class="govuk-heading-s">Drawing instructions</h3>
            <ul class="govuk-list govuk-list--bullet">
                <li>Click on the map to add points to your boundary</li>
                <li>Double-click to complete the boundary</li>
                <li>Use the "Clear drawing" button to start over</li>
                <li>Make sure your boundary accurately represents your development site</li>
            </ul>
        </div>

        <div id="boundary-info" class="govuk-inset-text" style="display: none;">
            <h3 class="govuk-heading-s">Boundary information</h3>
            <div id="boundary-details"></div>
        </div>

        <div id="drawing-error" class="govuk-error-summary" style="display: none;" aria-labelledby="error-summary-title"
            role="alert" tabindex="-1">
            <h2 class="govuk-error-summary__title" id="error-summary-title">
                There is a problem
            </h2>
            <div class="govuk-error-summary__body">
                <ul class="govuk-list govuk-error-summary__list" id="error-list">
                </ul>
            </div>
        </div>

        <div class="govuk-button-group">
            <button class="govuk-button" data-module="govuk-button" onclick="clearDrawing()">
                Clear drawing
            </button>
            <button class="govuk-button" data-module="govuk-button" onclick="continueToData()" id="continue-button"
                disabled>
                Continue
            </button>
            <a href="/applications/new/location" class="govuk-button govuk-button--secondary"
                data-module="govuk-button">
                Back
            </a>
        </div>

    </div>

    <div class="govuk-grid-column-one-third">
        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Map controls</h2>
                <ul class="govuk-list govuk-list--bullet">
                    <li><strong>Zoom:</strong> Use mouse wheel or +/- buttons</li>
                    <li><strong>Pan:</strong> Click and drag to move around</li>
                    <li><strong>Draw:</strong> Click to add boundary points</li>
                    <li><strong>Complete:</strong> Double-click to finish drawing</li>
                </ul>
            </div>
        </div>

        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Boundary requirements</h2>
                <ul class="govuk-list govuk-list--bullet">
                    <li>Must be a closed polygon</li>
                    <li>Minimum 3 points required</li>
                    <li>Maximum area of 100 hectares</li>
                    <li>Must be within the UK</li>
                </ul>
            </div>
        </div>

        <div class="govuk-card govuk-card--contained">
            <div class="govuk-card__content">
                <h2 class="govuk-heading-s">Application progress</h2>
                <ol class="govuk-list govuk-list--number">
                    <li>Location</li>
                    <li><strong>EDP check</strong> ← You are here</li>
                    <li>Additional details</li>
                    <li>Review quote</li>
                    <li>Payment</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let drawingLayer;
    let boundaryPolygon;
    let boundaryPoints = [];

    document.addEventListener('DOMContentLoaded', function () {
        initializeMap();
        loadDevelopmentLocation();
    });

    function initializeMap() {
        // Initialize the map centered on the UK
        map = L.map('map').setView([54.0, -2.0], 6);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Create a layer for drawing
        drawingLayer = L.layerGroup().addTo(map);

        // Add click event to map for drawing
        map.on('click', function (e) {
            addPointToBoundary(e.latlng);
        });

        // Add double-click event to complete boundary
        map.on('dblclick', function (e) {
            e.originalEvent.preventDefault();
            completeBoundary();
        });
    }

    function loadDevelopmentLocation() {
        // Check for location data from postcode or coordinates
        const locationData = sessionStorage.getItem('developmentLocation');
        const coordinatesData = sessionStorage.getItem('developmentCoordinates');
        const postcodeData = sessionStorage.getItem('developmentPostcode');

        if (locationData) {
            const location = JSON.parse(locationData);
            if (location.coordinates) {
                // Center map on the development location
                map.setView([location.coordinates.lat, location.coordinates.lng], 14);

                // Add a marker for the development site
                const marker = L.marker([location.coordinates.lat, location.coordinates.lng])
                    .addTo(drawingLayer)
                    .bindPopup('Development site location');
            }
        } else if (coordinatesData) {
            const coordinates = JSON.parse(coordinatesData);
            // Center map on the coordinates
            map.setView([coordinates.lat, coordinates.lng], 14);

            // Add a marker for the development site
            const marker = L.marker([coordinates.lat, coordinates.lng])
                .addTo(drawingLayer)
                .bindPopup('Development site location');
        }
    }

    function addPointToBoundary(latlng) {
        boundaryPoints.push(latlng);

        // Add marker for the point
        const marker = L.marker(latlng)
            .addTo(drawingLayer)
            .bindPopup(`Point ${boundaryPoints.length}`);

        // Update the polygon if we have enough points
        if (boundaryPoints.length >= 3) {
            updateBoundaryPolygon();
        }

        // Enable continue button if we have a valid boundary
        updateContinueButton();
    }

    function updateBoundaryPolygon() {
        // Remove existing polygon
        if (boundaryPolygon) {
            drawingLayer.removeLayer(boundaryPolygon);
        }

        // Create new polygon
        boundaryPolygon = L.polygon(boundaryPoints, {
            color: 'red',
            weight: 3,
            fillColor: '#ff0000',
            fillOpacity: 0.2
        }).addTo(drawingLayer);

        // Update boundary information
        updateBoundaryInfo();
    }

    function completeBoundary() {
        if (boundaryPoints.length < 3) {
            showError(['You need at least 3 points to create a boundary']);
            return;
        }

        // Close the polygon by adding the first point again
        if (boundaryPoints.length > 0) {
            boundaryPoints.push(boundaryPoints[0]);
            updateBoundaryPolygon();
        }

        updateContinueButton();
    }

    function clearDrawing() {
        // Clear all layers
        drawingLayer.clearLayers();

        // Reset variables
        boundaryPoints = [];
        boundaryPolygon = null;

        // Hide boundary info
        document.getElementById('boundary-info').style.display = 'none';

        // Disable continue button
        document.getElementById('continue-button').disabled = true;

        // Hide any errors
        hideError();
    }

    function updateBoundaryInfo() {
        if (boundaryPoints.length < 3) return;

        const boundaryDetails = document.getElementById('boundary-details');
        const boundaryInfo = document.getElementById('boundary-info');

        // Calculate area (simplified calculation)
        const area = calculatePolygonArea(boundaryPoints);
        const areaHectares = area / 10000; // Convert to hectares

        boundaryDetails.innerHTML = `
            <p class="govuk-body"><strong>Number of points:</strong> ${boundaryPoints.length}</p>
            <p class="govuk-body"><strong>Approximate area:</strong> ${areaHectares.toFixed(2)} hectares</p>
            <p class="govuk-body"><strong>Status:</strong> ${areaHectares <= 100 ? 'Valid' : 'Too large'}</p>
        `;

        boundaryInfo.style.display = 'block';
    }

    function calculatePolygonArea(points) {
        // Simplified area calculation using shoelace formula
        let area = 0;
        const n = points.length;

        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            area += points[i].lat * points[j].lng;
            area -= points[j].lat * points[i].lng;
        }

        return Math.abs(area) * 111320 * 111320; // Convert to square meters
    }

    function updateContinueButton() {
        const continueButton = document.getElementById('continue-button');
        const isValid = boundaryPoints.length >= 3;

        continueButton.disabled = !isValid;
    }

    function continueToData() {
        if (boundaryPoints.length < 3) {
            showError(['You need to draw a complete boundary before continuing']);
            return;
        }

        // Store boundary data in session storage
        const boundaryData = {
            points: boundaryPoints.map(point => [point.lng, point.lat]), // GeoJSON format: [lng, lat]
            center: calculateCenter(boundaryPoints),
            area: calculatePolygonArea(boundaryPoints)
        };

        sessionStorage.setItem('developmentBoundary', JSON.stringify(boundaryData));

        // Also store in a form and submit to server to save in session
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/applications/new/location-draw';

        const boundaryInput = document.createElement('input');
        boundaryInput.type = 'hidden';
        boundaryInput.name = 'boundary-data';
        boundaryInput.value = JSON.stringify(boundaryData);

        form.appendChild(boundaryInput);
        document.body.appendChild(form);
        form.submit();
    }

    function calculateCenter(points) {
        const lat = points.reduce((sum, point) => sum + point.lat, 0) / points.length;
        const lng = points.reduce((sum, point) => sum + point.lng, 0) / points.length;
        return [lng, lat]; // GeoJSON format: [lng, lat]
    }

    function showError(errors) {
        const errorList = document.getElementById('error-list');
        errorList.innerHTML = '';
        errors.forEach(error => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#map-container';
            a.textContent = error;
            li.appendChild(a);
            errorList.appendChild(li);
        });
        document.getElementById('drawing-error').style.display = 'block';
    }

    function hideError() {
        document.getElementById('drawing-error').style.display = 'none';
    }
</script>

{% endblock %}